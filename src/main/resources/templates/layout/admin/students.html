<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Manage Students</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .05);
        }

        .card-header {
            background-color: #007bff;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            font-weight: bold;
        }

        .table thead th {
            background-color: #007bff;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .modal-header {
            background-color: #007bff;
            color: white;
        }

        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .is-invalid {
            border-color: #dc3545;
        }

        .is-valid {
            border-color: #28a745;
        }

        .error {
            font-size: 0.875em;
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-user-graduate"></i> Manage Students</span>
                <button class="btn btn-success" id="addStudentBtn"><i class="fas fa-user-plus"></i> Add Student</button>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="studentSearch" placeholder="Search by name or code">
                    <button class="btn btn-primary" type="button" id="searchStudentBtn"><i class="fas fa-search"></i>
                        Search</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="studentsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Student Code</th>
                                <th>Name</th>
                                <th>Sex</th>
                                <th>Register Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Student rows will be loaded here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="studentForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalLabel">Add/Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="studentId" name="studentId">
                    <div class="mb-3">
                        <label for="studentCode" class="form-label">Student Code</label>
                        <input type="text" class="form-control" id="studentCode" name="studentCode" required>
                        <div class="error"></div>
                    </div>
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="studentName" name="studentName" required>
                        <div class="error"></div>
                    </div>
                    <div class="mb-3">
                        <label for="studentSex" class="form-label">Sex</label>
                        <input type="text" class="form-control" id="studentSex" name="studentSex" required>
                        <div class="error"></div>
                    </div>
                    <div id="studentFormMsg" class="text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const studentsTableBody = document.querySelector('#studentsTable tbody');
            const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
            const studentForm = document.getElementById('studentForm');
            const studentFormMsg = document.getElementById('studentFormMsg');
            let editingStudentId = null;

            // Load students on page load
            loadStudents();

            // Search functionality
            document.getElementById('searchStudentBtn').onclick = function () {
                loadStudents(document.getElementById('studentSearch').value);
            };

            // Add Student button
            document.getElementById('addStudentBtn').onclick = function () {
                editingStudentId = null;
                studentForm.reset();
                clearValidation();
                studentFormMsg.textContent = '';
                document.getElementById('studentModalLabel').textContent = 'Add Student';
                studentModal.show();
            };

            // Handle form submit (add/edit)
            studentForm.onsubmit = function (e) {
                e.preventDefault();
                studentFormMsg.textContent = '';
                if (!validateForm()) return;
                const student = {
                    studentCode: studentForm.studentCode.value,
                    name: studentForm.studentName.value,
                    sex: studentForm.studentSex.value
                };
                let url = '/api/students';
                let method = 'POST';
                if (editingStudentId) {
                    url += '/' + editingStudentId;
                    method = 'PUT';
                }
                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(student)
                })
                    .then(res => {
                        if (!res.ok) return res.text().then(t => { throw new Error(t); });
                        return res.json();
                    })
                    .then(() => {
                        studentModal.hide();
                        loadStudents();
                    })
                    .catch(err => {
                        studentFormMsg.textContent = err.message || 'Failed to save student.';
                    });
            };

            // Load students from API
            function loadStudents(search = '') {
                let url = '/api/students';
                if (search) url += '?search=' + encodeURIComponent(search);
                fetch(url)
                    .then(res => res.json())
                    .then(students => {
                        studentsTableBody.innerHTML = students.map(student => `
                    <tr>
                        <td>${student.studentId || student.id}</td>
                        <td>${student.studentCode}</td>
                        <td>${student.name}</td>
                        <td>${student.sex}</td>
                        <td>${student.registerDate ? new Date(student.registerDate).toLocaleDateString() : ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" data-edit="${student.studentId || student.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-sm btn-danger" data-delete="${student.studentId || student.id}"><i class="fas fa-trash-alt"></i> Delete</button>
                        </td>
                    </tr>
                `).join('');
                    });
            }

            // Handle edit/delete buttons
            studentsTableBody.onclick = function (e) {
                if (e.target.closest('[data-edit]')) {
                    const id = e.target.closest('[data-edit]').getAttribute('data-edit');
                    fetch('/api/students/' + id)
                        .then(res => res.json())
                        .then(student => {
                            editingStudentId = id;
                            studentForm.studentCode.value = student.studentCode;
                            studentForm.studentName.value = student.name;
                            studentForm.studentSex.value = student.sex;
                            clearValidation();
                            studentFormMsg.textContent = '';
                            document.getElementById('studentModalLabel').textContent = 'Edit Student';
                            studentModal.show();
                        });
                }
                if (e.target.closest('[data-delete]')) {
                    const id = e.target.closest('[data-delete]').getAttribute('data-delete');
                    if (confirm('Are you sure you want to delete this student?')) {
                        fetch('/api/students/' + id, { method: 'DELETE' })
                            .then(res => {
                                if (!res.ok) throw new Error('Failed to delete student.');
                                loadStudents();
                            })
                            .catch(err => alert(err.message));
                    }
                }
            };

            // Form validation
            function validateForm() {
                let valid = true;
                clearValidation();

                if (!studentForm.studentCode.value.trim()) {
                    setError(studentForm.studentCode, "Student Code is required.");
                    valid = false;
                } else {
                    setSuccess(studentForm.studentCode);
                }

                if (!studentForm.studentName.value.trim()) {
                    setError(studentForm.studentName, "Name is required.");
                    valid = false;
                } else if (studentForm.studentName.value.length < 3) {
                    setError(studentForm.studentName, "Name must be at least 3 characters.");
                    valid = false;
                } else {
                    setSuccess(studentForm.studentName);
                }

                if (!studentForm.studentSex.value.trim()) {
                    setError(studentForm.studentSex, "Sex is required.");
                    valid = false;
                } else {
                    setSuccess(studentForm.studentSex);
                }

                return valid;
            }

            function setError(element, message) {
                const errorDisplay = element.parentElement.querySelector('.error');
                errorDisplay.innerText = message;
                element.classList.add('is-invalid');
                element.classList.remove('is-valid');
            }

            function setSuccess(element) {
                const errorDisplay = element.parentElement.querySelector('.error');
                errorDisplay.innerText = '';
                element.classList.remove('is-invalid');
                element.classList.add('is-valid');
            }

            function clearValidation() {
                studentForm.querySelectorAll('.form-control').forEach(el => {
                    el.classList.remove('is-invalid', 'is-valid');
                    const errorDisplay = el.parentElement.querySelector('.error');
                    if (errorDisplay) errorDisplay.innerText = '';
                });
            }
        });
    </script>
</body>

</html>